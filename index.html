<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—ë–ø–ª–∞—è –°–µ—Ä–≤–µ—Ä–Ω–∞—è ‚Äî —É—é—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏</title>
  <meta name="description" content="–õ–∏—á–Ω—ã–π —É—é—Ç–Ω—ã–π —Å–∞–π—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∫ —Ç—ë–ø–ª—ã–µ –∑–∞–º–µ—Ç–∫–∏." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚òïÔ∏è</text></svg>">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cozy: {
              50: '#FFF7ED',   // —Ç–µ–ø–ª–µ–µ —Ñ–æ–Ω
              100: '#FFEFD9',
              200: '#FFE1B8',
              300: '#FFD095',
              400: '#FFBA6E',
              500: '#F79C3E',  // –∞–∫—Ü–µ–Ω—Ç
              600: '#E3842C',
              700: '#C56A1F',
              800: '#944E17',
              900: '#5C2F0E'
            }
          },
          boxShadow: {
            cozy: '0 12px 48px -12px rgba(148, 78, 23, 0.25)'
          },
          keyframes: {
            fadeUp: { '0%': { opacity: 0, transform:'translateY(8px)' }, '100%': { opacity:1, transform:'none' } },
            pop: { '0%': { transform:'scale(.98)' }, '100%': { transform:'scale(1)' } },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            }
          },
          animation: {
            fadeUp: 'fadeUp .35s ease-out both',
            pop: 'pop .12s ease-out both',
            shimmer: 'shimmer 1.5s linear infinite'
          }
        }
      }
    }
  </script>
  <style>
    .ring-focus { box-shadow: 0 0 0 3px rgba(247,156,62,0.35); }
    .prose p { margin: 0.75rem 0; line-height: 1.75; }
    .prose h2 { font-weight: 700; margin-top: 1.25rem; font-size: 1.25rem; }
    .prose h3 { font-weight: 600; margin-top: 1rem; }
    .prose a { text-decoration: underline; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Card hover */
    .card { transition: transform .15s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 14px 40px -16px rgba(92,47,14,.35); }
  </style>
</head>
<body class="h-full bg-cozy-50 text-stone-800 selection:bg-cozy-200 selection:text-stone-900">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur bg-cozy-50/85 border-b border-cozy-200">
      <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
        <button id="homeBtn" class="shrink-0 rounded-2xl p-2 hover:bg-cozy-100" title="–ù–∞ –≥–ª–∞–≤–Ω—É—é">üè†</button>
        <h1 class="text-xl sm:text-2xl font-bold tracking-tight">–¢—ë–ø–ª–∞—è –°–µ—Ä–≤–µ—Ä–Ω–∞—è</h1>
        <span class="ml-2 text-sm text-stone-600 hidden sm:inline">—É—é—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ —Å–≤–æ—ë–º</span>
        <div class="ml-auto flex items-center gap-2">
          <button id="newPostBtn" class="rounded-2xl px-3 py-1.5 bg-cozy-500 text-white hover:bg-cozy-600 shadow-cozy" title="–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å">+ –ù–æ–≤–∞—è</button>
        </div>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="border-b border-cozy-200 bg-white/70 backdrop-blur">
      <div class="max-w-3xl mx-auto px-4 py-2 flex gap-2 items-center">
        <div class="relative flex-1 animate-fadeUp">
          <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏ —Ç–µ–∫—Å—Ç—É‚Ä¶ (/)" class="w-full rounded-2xl border border-cozy-200 bg-white px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-cozy-300"/>
          <span class="absolute right-3 top-2.5">üîé</span>
        </div>
        <button id="exportBtn" class="rounded-2xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100" title="–≠–∫—Å–ø–æ—Ä—Ç JSON">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <label class="rounded-2xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100 cursor-pointer" title="–ò–º–ø–æ—Ä—Ç JSON">
          –ò–º–ø–æ—Ä—Ç
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="backupBtn" class="rounded-2xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100" title="–°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é">–ë—ç–∫–∞–ø</button>
        <button id="rssBtn" class="rounded-2xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å RSS">RSS</button>
      </div>
    </div>

    <!-- Tag Row -->
    <div id="tagRow" class="max-w-3xl mx-auto px-4 pt-2 pb-1 flex gap-2 overflow-x-auto no-scrollbar"></div>

    <!-- Main content -->
    <main class="max-w-3xl mx-auto w-full px-4 py-6 flex-1">
      <section id="listView" class="grid gap-4"></section>
      <article id="postView" class="hidden"></article>
    </main>

    <!-- Footer -->
    <footer class="border-t border-cozy-200 bg-white/70">
      <div class="max-w-3xl mx-auto px-4 py-6 text-sm text-stone-600 flex flex-wrap items-center gap-3">
        <span>‚òïÔ∏è –°–¥–µ–ª–∞–Ω–æ —Å —Ç–µ–ø–ª–æ–º. </span>
        <span id="persistInfo" class="opacity-70">–•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω: –ø—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶</span>
        <button id="aboutBtn" class="ml-auto underline hover:text-stone-900">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</button>
      </div>
    </footer>
  </div>

  <!-- Compose Dialog -->
  <dialog id="compose" class="rounded-2xl w-[min(880px,92vw)] p-0 border-0 shadow-2xl">
    <form method="dialog" class="bg-white rounded-2xl">
      <div class="px-5 py-4 border-b border-stone-200 flex items-center gap-3">
        <h2 class="text-lg font-semibold">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        <span class="ml-auto text-sm text-stone-500" id="autosaveInfo"></span>
        <button type="button" id="closeCompose" class="rounded-xl px-3 py-1.5 hover:bg-stone-100">‚úï</button>
      </div>
      <div class="p-5 grid gap-3">
        <input id="titleInput" class="rounded-xl border border-stone-300 px-3 py-2 focus:ring-2 focus:ring-cozy-300" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (N ‚Äî –æ—Ç–∫—Ä—ã—Ç—å)" />
        <textarea id="contentInput" class="rounded-xl border border-stone-300 px-3 py-2 h-60 resize-y focus:ring-2 focus:ring-cozy-300" placeholder="–¢–µ–∫—Å—Ç (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Markdown)"></textarea>
        <input id="tagsInput" class="rounded-xl border border-stone-300 px-3 py-2 focus:ring-2 focus:ring-cozy-300" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: –¥–æ–º, –º—ã—Å–ª–∏, –∑–∞–º–µ—Ç–∫–∏" />
        <p class="text-xs text-stone-500">–°–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à: ‚åò/Ctrl+S ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫, ‚åò/Ctrl+Enter ‚Äî –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å.</p>
      </div>
      <div class="px-5 py-4 border-t border-stone-200 flex items-center gap-2">
        <button type="button" id="saveDraftBtn" class="rounded-xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
        <button type="button" id="publishBtn" class="rounded-xl px-3 py-1.5 bg-cozy-500 text-white hover:bg-cozy-600">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        <button type="button" id="deleteDraftBtn" class="ml-auto text-stone-500 hover:text-red-600">–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
      </div>
    </form>
  </dialog>

  <template id="postCardTpl">
    <article class="card rounded-2xl bg-white border border-cozy-200 p-4 shadow-sm animate-fadeUp cursor-pointer">
      <h3 class="font-semibold text-lg mb-1 line-clamp-1"></h3>
      <p class="text-stone-600 text-sm mb-2 line-clamp-2"></p>
      <div class="flex items-center gap-2 text-xs text-stone-500">
        <time></time>
        <div class="ml-auto flex gap-1"></div>
      </div>
    </article>
  </template>

  <script>
  // --- Storage & Persistence ---
  const THEME_KEY = 'cozy_theme_disabled'; // —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∫–ª—é—á, –Ω–æ —Ç–µ–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞
  const DRAFT_KEY = 'cozy_draft';
  const STORAGE_KEY_LEGACY = 'cozy_posts_v1';

  /** @type {Array<{id:string,title:string,content:string,tags:string[],created:string,updated?:string}>} */
  let posts = [];

  const byId = (id) => document.getElementById(id);

  // IndexedDB minimal helpers
  let dbPromise = null;
  function openDB(){
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject)=>{
      const req = indexedDB.open('cozy_db', 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains('posts')) db.createObjectStore('posts', { keyPath: 'id' });
        if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
    return dbPromise;
  }
  async function idbGetAll(){
    try {
      const db = await openDB();
      return await new Promise((resolve, reject)=>{
        const tx = db.transaction('posts','readonly');
        const store = tx.objectStore('posts');
        const req = store.getAll();
        req.onsuccess = ()=> resolve(req.result || []);
        req.onerror = ()=> reject(req.error);
      });
    } catch { return []; }
  }
  async function idbPutAll(list){
    try {
      const db = await openDB();
      await new Promise((resolve, reject)=>{
        const tx = db.transaction(['posts','meta'],'readwrite');
        const ps = tx.objectStore('posts');
        const meta = tx.objectStore('meta');
        const clearReq = ps.clear();
        clearReq.onsuccess = () => {
          list.forEach(item => ps.put(item));
          meta.put({ key: 'updated', value: new Date().toISOString() });
        };
        tx.oncomplete = resolve;
        tx.onerror = ()=> reject(tx.error);
      });
    } catch (e) { console.warn('IDB save error', e); }
  }

  // OPFS snapshot (Chromium)
  async function opfsSnapshot(list){
    try {
      if (!('storage' in navigator) || !navigator.storage.getDirectory) return;
      const root = await navigator.storage.getDirectory();
      const fh = await root.getFileHandle('posts.json', { create: true });
      const w = await fh.createWritable();
      await w.write(new Blob([JSON.stringify(list, null, 2)], { type: 'application/json' }));
      await w.close();
    } catch (e) { console.info('OPFS snapshot skipped', e?.message); }
  }

  async function requestPersistence(){
    try {
      const persisted = await (navigator.storage?.persist?.() || Promise.resolve(false));
      const est = await navigator.storage?.estimate?.();
      const quota = est?.quota ? Math.round(est.quota/1024/1024) + ' –ú–ë' : '‚Äî';
      const used = est?.usage ? Math.round(est.usage/1024/1024) + ' –ú–ë' : '‚Äî';
      const note = persisted ? '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: –≤–∫–ª—é—á–µ–Ω–æ' : '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ: –∑–∞–ø—Ä–æ—à–µ–Ω–æ';
      const extra = navigator.storage?.getDirectory ? ' + OPFS —Å–Ω–∞–ø—à–æ—Ç' : '';
      const el = byId('persistInfo'); if (el) el.textContent = `${note} (–∑–∞–Ω—è—Ç–æ ${used} –∏–∑ ${quota})${extra}`;
    } catch {
      const el = byId('persistInfo'); if (el) el.textContent = '–•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω: –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ';
    }
  }

  async function loadPosts(){
    // Try IDB first; fallback to localStorage (legacy)
    let list = await idbGetAll();
    if (!Array.isArray(list) || list.length === 0) {
      try { list = JSON.parse(localStorage.getItem(STORAGE_KEY_LEGACY) || '[]'); }
      catch { list = []; }
    }
    posts = Array.isArray(list) ? list : [];
  }

  async function savePosts(){
    await idbPutAll(posts);
    // Legacy secondary backup
    try { localStorage.setItem(STORAGE_KEY_LEGACY, JSON.stringify(posts)); } catch{}
    // Write OPFS snapshot when available
    opfsSnapshot(posts);
  }

  function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function formatDate(iso) { const d = new Date(iso); return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric'}); }

  // --- Markdown lite to HTML ---
  function mdToHtml(md) {
    return md
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold my-2">$1</h1>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`([^`]+)`/g, '<code class="px-1 rounded bg-stone-100">$1</code>')
      .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="underline text-cozy-700">$1<\/a>')
      .replace(/
/g, '<br/>');
  }

  // --- Rendering ---
  const listView = byId('listView');
  const postView = byId('postView');
  const searchInput = byId('search');
  const tagRow = byId('tagRow');

  function renderTags(activeTag = null) {
    const all = new Set();
    posts.forEach(p => p.tags.forEach(t => all.add(t)));
    tagRow.innerHTML = '';
    if (all.size === 0) return;
    const makeBtn = (label, isActive) => {
      const b = document.createElement('button');
      b.textContent = label;
      b.className = 'rounded-full px-3 py-1 text-sm border transition ' + (isActive ? 'bg-cozy-500 text-white border-cozy-600' : 'border-cozy-300 hover:bg-cozy-100');
      b.addEventListener('click', () => renderList(label === '–í—Å–µ' ? null : label));
      return b;
    };
    tagRow.appendChild(makeBtn('–í—Å–µ', activeTag === null));
    [...all].sort().forEach(t => tagRow.appendChild(makeBtn(t, t === activeTag)));
  }

  function renderList(filterTag = null) {
    postView.classList.add('hidden');
    listView.classList.remove('hidden');

    const q = (searchInput.value || '').toLowerCase().trim();
    const filtered = posts.filter(p => {
      const okTag = filterTag ? p.tags.includes(filterTag) : true;
      const okQ = q ? (p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q)) : true;
      return okTag && okQ;
    });

    listView.innerHTML = '';
    if (filtered.length === 0) {
      listView.innerHTML = `<div class="text-center text-stone-500 py-16 animate-fadeUp">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤–∞—è¬ª –∏ —Å–æ–≥—Ä–µ–π—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å—å—é ‚òïÔ∏è</div>`;
      renderTags(filterTag);
      return;
    }

    filtered
      .slice()
      .sort((a,b)=> new Date(b.created) - new Date(a.created))
      .forEach(p => {
        const tpl = document.getElementById('postCardTpl').content.cloneNode(true);
        const el = tpl.querySelector('article');
        tpl.querySelector('h3').textContent = p.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        tpl.querySelector('p').textContent = p.content.replace(/
/g,' ').slice(0,160);
        const time = tpl.querySelector('time');
        time.textContent = formatDate(p.created);
        const tagsWrap = tpl.querySelector('div div');
        p.tags.forEach(t => {
          const tag = document.createElement('span');
          tag.textContent = t;
          tag.className = 'rounded-full bg-cozy-100 text-stone-700 px-2 py-0.5 border border-cozy-200';
          tagsWrap.appendChild(tag);
        });
        el.addEventListener('click', ()=> showPost(p.id));
        listView.appendChild(tpl);
      });

    renderTags(filterTag);
  }

  function showPost(id) {
    const p = posts.find(x=>x.id===id);
    if (!p) return;
    listView.classList.add('hidden');
    postView.className = 'bg-white rounded-2xl border border-cozy-200 p-5 shadow-md animate-fadeUp';
    postView.innerHTML = `
      <div class="flex items-start gap-3">
        <h2 class="text-2xl font-bold flex-1">${escapeHtml(p.title) || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}</h2>
        <button class="rounded-xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100" id="editBtn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="text-sm text-stone-500 mt-1">${formatDate(p.created)}${p.updated ? ' ‚Ä¢ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ' + formatDate(p.updated) : ''}</div>
      <div class="flex gap-2 mt-2">${p.tags.map(t=>`<span class='rounded-full bg-cozy-100 px-2 py-0.5 border border-cozy-200'>${escapeHtml(t)}</span>`).join('')}</div>
      <div class="prose prose-stone mt-4">${mdToHtml(escapeHtml(p.content))}</div>
      <div class="mt-6 flex gap-2">
        <button id="backBtn" class="rounded-xl px-3 py-1.5 border border-cozy-300 hover:bg-cozy-100">‚Üê –ù–∞–∑–∞–¥</button>
        <button id="deleteBtn" class="ml-auto text-red-700 hover:underline">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    byId('backBtn').addEventListener('click', ()=> renderList());
    byId('deleteBtn').addEventListener('click', ()=> {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) {
        posts = posts.filter(x=>x.id!==id); savePosts(); renderList();
      }
    });
    byId('editBtn').addEventListener('click', ()=> openCompose(p));
  }

  function escapeHtml(str='') {
    return str.replace(/[&<>"'] /g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m] || m));
  }

  // --- Compose ---
  const compose = byId('compose');
  const titleInput = byId('titleInput');
  const contentInput = byId('contentInput');
  const tagsInput = byId('tagsInput');
  const autosaveInfo = byId('autosaveInfo');

  let editingId = null;
  let autosaveTimer = null;

  function openCompose(post=null) {
    editingId = post?.id || null;
    const draft = post || loadDraft();
    titleInput.value = draft?.title || '';
    contentInput.value = draft?.content || '';
    tagsInput.value = draft?.tags?.join(', ') || '';
    autosaveInfo.textContent = '–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';
    compose.showModal();
    titleInput.focus();
  }

  function closeCompose() {
    compose.close();
    clearTimeout(autosaveTimer);
  }

  function loadDraft() {
    try { return JSON.parse(localStorage.getItem(DRAFT_KEY) || 'null'); }
    catch { return null; }
  }

  function saveDraft() {
    const draft = { title: titleInput.value, content: contentInput.value, tags: parseTags(tagsInput.value) };
    localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    autosaveInfo.textContent = '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
    setTimeout(()=> autosaveInfo.textContent='–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ', 1200);
  }

  function deleteDraft() {
    localStorage.removeItem(DRAFT_KEY);
    autosaveInfo.textContent = '–ß–µ—Ä–Ω–æ–≤–∏–∫ —É–¥–∞–ª—ë–Ω';
  }

  function parseTags(s) { return (s || '').split(',').map(t=>t.trim()).filter(Boolean).slice(0,12); }

  function publish() {
    const data = {
      id: editingId || uid(),
      title: titleInput.value.trim(),
      content: contentInput.value.trim(),
      tags: parseTags(tagsInput.value),
      created: new Date().toISOString()
    };
    if (editingId) {
      const idx = posts.findIndex(p=>p.id===editingId);
      if (idx>-1) {
        data.created = posts[idx].created;
        data.updated = new Date().toISOString();
        posts[idx] = data;
      }
    } else { posts.push(data); }
    savePosts(); deleteDraft(); closeCompose(); renderList();
  }

  // --- Export / Import / RSS / Backup ---
  function download(filename, text, type='application/json') {
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  }
  function exportJson() {
    const name = 'cozy-posts-' + new Date().toISOString().slice(0,10) + '.json';
    download(name, JSON.stringify(posts, null, 2));
  }
  function backupJson() {
    const name = 'cozy-backup-' + new Date().toISOString().replace(/[:T]/g,'-').slice(0,19) + '.json';
    download(name, JSON.stringify(posts, null, 2));
  }
  function generateRSS() {
    const site = location.origin + location.pathname;
    const xml = `<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"><channel>
<title>–¢—ë–ø–ª–∞—è –°–µ—Ä–≤–µ—Ä–Ω–∞—è</title>
<link>${site}</link>
<description>–£—é—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏</description>
${posts.slice().sort((a,b)=>new Date(b.created)-new Date(a.created)).map(p=>`<item>
<title>${escapeXml(p.title)}</title>
<link>${site}#${p.id}</link>
<guid>${p.id}</guid>
<pubDate>${new Date(p.created).toUTCString()}</pubDate>
<description><![CDATA[${p.content}]]></description>
</item>`).join('
')}
</channel></rss>`;
    download('rss.xml', xml, 'application/rss+xml');
  }
  function escapeXml(str='') { return str.replace(/[<>&'\"]/g, c=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;","\"":"&quot;"}[c])); }

  // --- Events & Shortcuts ---
  byId('newPostBtn').addEventListener('click', ()=> openCompose());
  byId('closeCompose').addEventListener('click', closeCompose);
  byId('saveDraftBtn').addEventListener('click', saveDraft);
  byId('publishBtn').addEventListener('click', publish);
  byId('deleteDraftBtn').addEventListener('click', ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?')) deleteDraft(); });
  byId('homeBtn').addEventListener('click', ()=> renderList());
  byId('aboutBtn').addEventListener('click', ()=> {
    const demo = { title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', content: '–≠—Ç–æ –≤–∞—à–∞ —Ç—ë–ø–ª–∞—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è. –ü–∏—à–∏—Ç–µ –º—ã—Å–ª–∏, –∑–∞–º–µ—Ç–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∏. ‚Üí –ö–Ω–æ–ø–∫–∞ **–ù–æ–≤–∞—è** –≤–≤–µ—Ä—Ö—É. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON –∏–ª–∏ RSS. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!

# –ü–æ–¥—Å–∫–∞–∑–∫–∏
- –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É —Å–≤–µ—Ä—Ö—É (–Ω–∞–∂–º–∏—Ç–µ /).
- –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: –¥–æ–º, –∏–¥–µ–∏.
- –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∑–∞–ø–∏—Å—å.
- –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ (–æ—Ñ–ª–∞–π–Ω).', tags: ['–ø—Ä–∏–≤–µ—Ç', '–ø–æ–¥—Å–∫–∞–∑–∫–∏'], created: new Date().toISOString(), id: uid() };
    posts.push(demo); savePosts(); renderList();
    alert('–î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å üôÇ');
  });

  byId('exportBtn').addEventListener('click', exportJson);
  byId('backupBtn').addEventListener('click', backupJson);
  byId('importInput').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    try { const data = JSON.parse(text); if(Array.isArray(data)) { posts = data; savePosts(); renderList(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!'); } else throw 0; }
    catch { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª. –≠—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π.'); }
    e.target.value = '';
  });
  byId('rssBtn').addEventListener('click', generateRSS);

  // Shortcuts
  window.addEventListener('keydown', (e)=>{
    if (e.key === '/' && document.activeElement !== searchInput) { e.preventDefault(); searchInput.focus(); return; }
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') { e.preventDefault(); if (compose.open) saveDraft(); return; }
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); if (compose.open) publish(); return; }
    if (e.key.toLowerCase() === 'n' && !compose.open) { openCompose(); return; }
  });

  // Autosave draft while typing
  ;['input','change'].forEach(evt=>{
    ;['titleInput','contentInput','tagsInput'].forEach(id=> byId(id).addEventListener(evt, ()=>{
      clearTimeout(autosaveTimer); autosaveTimer = setTimeout(saveDraft, 800);
    }));
  });

  // Init
  (async function init(){
    await requestPersistence();
    await loadPosts();
    renderList();
  })();
  </script>
</body>
</html>
